# fz-modelica

Modelica plugin for the [fz](https://github.com/Funz/fz) framework - parametric scientific computing.

This plugin allows you to run parametric studies with Modelica models using the fz framework.

## Prerequisites

### Required Software

1. **OpenModelica Compiler (omc)**

   For Ubuntu/Debian:
   ```bash
   sudo apt-get update
   sudo apt-get install ca-certificates curl gnupg
   sudo curl -fsSL http://build.openmodelica.org/apt/openmodelica.asc | \
     sudo gpg --dearmor -o /usr/share/keyrings/openmodelica-keyring.gpg
   
   echo "deb [arch=amd64 signed-by=/usr/share/keyrings/openmodelica-keyring.gpg] \
     https://build.openmodelica.org/apt \
     $(cat /etc/os-release | grep "\(UBUNTU\|DEBIAN\|VERSION\)_CODENAME" | sort | cut -d= -f 2 | head -1) \
     stable" | sudo tee /etc/apt/sources.list.d/openmodelica.list
   
   sudo apt install --no-install-recommends omc
   ```

   For other platforms, see [OpenModelica installation guide](https://openmodelica.org/download/download-linux/).

2. **fz Framework**

   ```bash
   pip install funz-fz
   # or
   pip install -e git+https://github.com/Funz/fz.git
   ```

3. **Python Dependencies**

   ```bash
   pip install pandas matplotlib
   ```

## Installation

Clone this repository:
```bash
git clone https://github.com/Funz/fz-modelica.git
cd fz-modelica
```

## Quick Start

### Using the Sample Model

The repository includes a sample Newton's cooling model (`samples/NewtonCooling.mo`).

#### 1. Parse Input Variables

```python
import fz

# Identify variables in the model
variables = fz.fzi("samples/NewtonCooling.mo", "Modelica")
print(variables)
# Output: {'convection': None}
```

#### 2. Run a Single Case

```python
import fz

results = fz.fzr(
    "samples/NewtonCooling.mo",
    {"convection": 0.7},
    "Modelica",
    calculators="localhost",
    results_dir="results_single"
)

print(results)
```

#### 3. Run Parametric Study

```python
import fz

results = fz.fzr(
    "samples/NewtonCooling.mo",
    {"convection": [0.1, 0.3, 0.5, 0.7, 0.9]},
    "Modelica",
    calculators="localhost",
    results_dir="results_parametric"
)

print(results)
```

#### 4. Visualize Results

```python
import fz
import matplotlib.pyplot as plt

results = fz.fzr(
    "samples/NewtonCooling.mo",
    {"convection": [0.1, 0.3, 0.5, 0.7, 0.9]},
    "Modelica",
    calculators="localhost",
    results_dir="results"
)

# Plot temperature evolution for each case
for idx, row in results.iterrows():
    convection = row['convection']
    res_data = row['res']['NewtonCooling']
    time = list(res_data['time'].values())
    temp = list(res_data['T'].values())
    plt.plot(time, temp, label=f'h={convection}')

plt.xlabel('Time (s)')
plt.ylabel('Temperature (°C)')
plt.title("Newton's Law of Cooling - Temperature vs Time")
plt.legend()
plt.grid(True)
plt.savefig('cooling_curves.png')
print("Plot saved to cooling_curves.png")
```

## Model Configuration

The Modelica model configuration is defined in `.fz/models/Modelica.json`:

```json
{
    "id": "Modelica",
    "varprefix": "$",
    "formulaprefix": "@",
    "delim": "{}",
    "commentline": "//",
    "output": {
        "res": "python -c 'import pandas;import glob;import json;print(json.dumps({f.split(\"_res.csv\")[0]:pandas.read_csv(f).to_dict() for f in glob.glob(\"*_res.csv\")}))'"
    }
}
```

### Variable Syntax in Modelica Files

Variables are defined using the `${variable_name}` or `${variable_name~default_value}` syntax:

```modelica
model Example
  parameter Real h=${convection~0.7} "Convective coefficient";
  parameter Real temp=${temperature} "Temperature";
  ...
end Example;
```

### Output Format

The plugin extracts results from the `*_res.csv` file generated by OpenModelica and returns them as a nested dictionary containing time-series data.

## Calculator Configuration

The localhost calculator is defined in `.fz/calculators/localhost.json`:

```json
{
    "uri": "sh://",
    "models": {
      "Modelica":"bash .fz/calculators/Modelica.sh"
    }
}
```

## Advanced Usage

### Using Cache

Reuse previous results to avoid redundant calculations:

```python
import fz

results = fz.fzr(
    "samples/NewtonCooling.mo",
    {"convection": [0.1, 0.3, 0.5, 0.7, 0.9]},
    "Modelica",
    calculators=["cache://results_*", "localhost"],
    results_dir="results_cached"
)
```

### Parallel Execution

Run multiple cases in parallel:

```python
import fz

results = fz.fzr(
    "samples/NewtonCooling.mo",
    {"convection": [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0]},
    "Modelica",
    calculators=["localhost"] * 3,  # Use 3 parallel workers
    results_dir="results_parallel"
)
```

### Using Inline Model Definition

Instead of using the "Modelica" alias, you can define the model inline:

```python
import fz

model = {
    "varprefix": "$",
    "formulaprefix": "@",
    "delim": "{}",
    "commentline": "//",
    "output": {
        "res": "python -c 'import pandas;import glob;import json;print(json.dumps({f.split(\"_res.csv\")[0]:pandas.read_csv(f).to_dict() for f in glob.glob(\"*_res.csv\")}))'"
    }
}

results = fz.fzr(
    "samples/NewtonCooling.mo",
    {"convection": [0.5, 0.7, 0.9]},
    model,
    calculators="sh://bash .fz/calculators/Modelica.sh",
    results_dir="results"
)
```

## CLI Usage

You can also use fz from the command line:

```bash
# Parse variables
fzi samples/NewtonCooling.mo --model Modelica --format table

# Run parametric study
fzr samples/NewtonCooling.mo \
  --model Modelica \
  --variables '{"convection": [0.5, 0.7, 0.9]}' \
  --calculator localhost \
  --results results/ \
  --format table
```

## Creating Your Own Modelica Models

1. Create a `.mo` file with your model
2. Mark parameters you want to vary with `${variable_name}` or `${variable_name~default}`
3. Run with fz:

```python
import fz

results = fz.fzr(
    "your_model.mo",
    {
        "param1": [1, 2, 3],
        "param2": [10, 20, 30]
    },
    "Modelica",
    calculators="localhost",
    results_dir="results"
)
```

## Troubleshooting

### OpenModelica not found

Make sure `omc` is in your PATH:
```bash
which omc
# Should output: /usr/bin/omc (or similar)
```

### Compilation errors

Check the `.moo` files in the results directory for detailed OpenModelica error messages.

### Missing Python packages

Install required packages:
```bash
pip install pandas matplotlib
```

## Directory Structure

```
fz-modelica/
├── .fz/
│   ├── models/
│   │   └── Modelica.json          # Model definition
│   └── calculators/
│       ├── localhost.json         # Calculator configuration
│       └── Modelica.sh            # Execution script
├── samples/
│   └── NewtonCooling.mo           # Sample model
└── README.md                      # This file
```

## Migration from Old Plugin

This is a port of the [old Modelica plugin](https://github.com/Funz/plugin-modelica) to the new fz framework.

**Key differences:**
- Old: `variableStartSymbol`, `variableLimit` → New: `varprefix`, `delim`
- Old: `output.???.get` syntax → New: `output` dictionary with shell commands
- Old: `.ioplugin` file → New: `.json` model definition
- Old: Separate `.bat` and `.sh` scripts → New: Single `.sh` script
- Configuration now uses `.fz/` directory structure

## License

BSD 3-Clause License (same as fz framework)

## Contributing

Contributions are welcome! Please submit issues and pull requests on GitHub.

## Related Projects

- [fz](https://github.com/Funz/fz) - The main fz framework
- [OpenModelica](https://openmodelica.org/) - Open-source Modelica compiler